
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>61. Metrics Library &#8212; Data Plane Development Kit 23.11.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="62. Telemetry Library" href="telemetry_lib.html" />
    <link rel="prev" title="60. Vhost Library" href="vhost_lib.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="metrics-library">
<span id="id1"></span><h1><span class="section-number">61. </span>Metrics Library</h1>
<p>The Metrics library implements a mechanism by which <em>producers</em> can
publish numeric information for later querying by <em>consumers</em>. In
practice producers will typically be other libraries or primary
processes, whereas consumers will typically be applications.</p>
<p>Metrics themselves are statistics that are not generated by PMDs. Metric
information is populated using a push model, where producers update the
values contained within the metric library by calling an update function
on the relevant metrics. Consumers receive metric information by querying
the central metric data, which is held in shared memory.</p>
<p>For each metric, a separate value is maintained for each port id, and
when publishing metric values the producers need to specify which port is
being updated. In addition there is a special id <code class="docutils literal notranslate"><span class="pre">RTE_METRICS_GLOBAL</span></code>
that is intended for global statistics that are not associated with any
individual device. Since the metrics library is self-contained, the only
restriction on port numbers is that they are less than <code class="docutils literal notranslate"><span class="pre">RTE_MAX_ETHPORTS</span></code>
- there is no requirement for the ports to actually exist.</p>
<section id="initializing-the-library">
<h2><span class="section-number">61.1. </span>Initializing the library</h2>
<p>Before the library can be used, it has to be initialized by calling
<code class="docutils literal notranslate"><span class="pre">rte_metrics_init()</span></code> which sets up the metric store in shared memory.
This is where producers will publish metric information to, and where
consumers will query it from.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">rte_metrics_init</span><span class="p">(</span><span class="n">rte_socket_id</span><span class="p">());</span><span class="w"></span>
</pre></div>
</div>
<p>This function <strong>must</strong> be called from a primary process, but otherwise
producers and consumers can be in either primary or secondary processes.</p>
</section>
<section id="registering-metrics">
<h2><span class="section-number">61.2. </span>Registering metrics</h2>
<p>Metrics must first be <em>registered</em>, which is the way producers declare
the names of the metrics they will be publishing. Registration can either
be done individually, or a set of metrics can be registered as a group.
Individual registration is done using <code class="docutils literal notranslate"><span class="pre">rte_metrics_reg_name()</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">id_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rte_metrics_reg_name</span><span class="p">(</span><span class="s">&quot;mean_bits_in&quot;</span><span class="p">);</span><span class="w"></span>
<span class="n">id_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rte_metrics_reg_name</span><span class="p">(</span><span class="s">&quot;mean_bits_out&quot;</span><span class="p">);</span><span class="w"></span>
<span class="n">id_3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rte_metrics_reg_name</span><span class="p">(</span><span class="s">&quot;peak_bits_in&quot;</span><span class="p">);</span><span class="w"></span>
<span class="n">id_4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rte_metrics_reg_name</span><span class="p">(</span><span class="s">&quot;peak_bits_out&quot;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>or alternatively, a set of metrics can be registered together using
<code class="docutils literal notranslate"><span class="pre">rte_metrics_reg_names()</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">names</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;mean_bits_in&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mean_bits_out&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;peak_bits_in&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;peak_bits_out&quot;</span><span class="p">,</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
<span class="n">id_set</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rte_metrics_reg_names</span><span class="p">(</span><span class="o">&amp;</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>If the return value is negative, it means registration failed. Otherwise
the return value is the <em>key</em> for the metric, which is used when updating
values. A table mapping together these key values and the metricsâ€™ names
can be obtained using <code class="docutils literal notranslate"><span class="pre">rte_metrics_get_names()</span></code>.</p>
</section>
<section id="updating-metric-values">
<h2><span class="section-number">61.3. </span>Updating metric values</h2>
<p>Once registered, producers can update the metric for a given port using
the <code class="docutils literal notranslate"><span class="pre">rte_metrics_update_value()</span></code> function. This uses the metric key
that is returned when registering the metric, and can also be looked up
using <code class="docutils literal notranslate"><span class="pre">rte_metrics_get_names()</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">rte_metrics_update_value</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span><span class="w"> </span><span class="n">id_1</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="n">rte_metrics_update_value</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span><span class="w"> </span><span class="n">id_2</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="n">rte_metrics_update_value</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span><span class="w"> </span><span class="n">id_3</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>
<span class="n">rte_metrics_update_value</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span><span class="w"> </span><span class="n">id_4</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span><span class="w"></span>
</pre></div>
</div>
<p>if metrics were registered as a single set, they can either be updated
individually using <code class="docutils literal notranslate"><span class="pre">rte_metrics_update_value()</span></code>, or updated together
using the <code class="docutils literal notranslate"><span class="pre">rte_metrics_update_values()</span></code> function:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">rte_metrics_update_value</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span><span class="w"> </span><span class="n">id_set</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="n">rte_metrics_update_value</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span><span class="w"> </span><span class="n">id_set</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"></span>
<span class="n">rte_metrics_update_value</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span><span class="w"> </span><span class="n">id_set</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span><span class="w"></span>
<span class="n">rte_metrics_update_value</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span><span class="w"> </span><span class="n">id_set</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span><span class="w"></span>

<span class="n">rte_metrics_update_values</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span><span class="w"> </span><span class="n">id_set</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">rte_metrics_update_values()</span></code> cannot be used to update
metric values from <em>multiple</em> <em>sets</em>, as there is no guarantee two
sets registered one after the other have contiguous id values.</p>
</section>
<section id="querying-metrics">
<h2><span class="section-number">61.4. </span>Querying metrics</h2>
<p>Consumers can obtain metric values by querying the metrics library using
the <code class="docutils literal notranslate"><span class="pre">rte_metrics_get_values()</span></code> function that return an array of
<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">rte_metric_value</span></code>. Each entry within this array contains a metric
value and its associated key. A key-name mapping can be obtained using the
<code class="docutils literal notranslate"><span class="pre">rte_metrics_get_names()</span></code> function that returns an array of
<code class="docutils literal notranslate"><span class="pre">struct</span> <span class="pre">rte_metric_name</span></code> that is indexed by the key. The following will
print out all metrics for a given port:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">print_metrics</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rte_metric_value</span><span class="w"> </span><span class="o">*</span><span class="n">metrics</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rte_metric_name</span><span class="w"> </span><span class="o">*</span><span class="n">names</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rte_metrics_get_names</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Cannot get metrics count</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">len</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;No metrics to display (none have been registered)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">metrics</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">rte_metric_value</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">len</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">names</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">rte_metric_name</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">len</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">metrics</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">names</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Cannot allocate memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">free</span><span class="p">(</span><span class="n">metrics</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">free</span><span class="p">(</span><span class="n">names</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rte_metrics_get_values</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span><span class="w"> </span><span class="n">metrics</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Cannot get metrics values</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">free</span><span class="p">(</span><span class="n">metrics</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">free</span><span class="p">(</span><span class="n">names</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Metrics for port %i:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">port_id</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">len</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;  %s: %&quot;</span><span class="n">PRIu64</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="n">names</span><span class="p">[</span><span class="n">metrics</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key</span><span class="p">].</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">metrics</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">metrics</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">names</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="deinitialising-the-library">
<h2><span class="section-number">61.5. </span>Deinitialising the library</h2>
<p>Once the library usage is done, it must be deinitialized by calling
<code class="docutils literal notranslate"><span class="pre">rte_metrics_deinit()</span></code> which will free the shared memory reserved
during initialization.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rte_metrics_deinit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>If the return value is negative, it means deinitialization failed.
This function <strong>must</strong> be called from a primary process.</p>
</section>
<section id="bit-rate-statistics-library">
<h2><span class="section-number">61.6. </span>Bit-rate statistics library</h2>
<p>The bit-rate library calculates the exponentially-weighted moving
average and peak bit-rates for each active port (i.e. network device).
These statistics are reported via the metrics library using the
following names:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">mean_bits_in</span></code>: Average inbound bit-rate</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mean_bits_out</span></code>:  Average outbound bit-rate</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ewma_bits_in</span></code>: Average inbound bit-rate (EWMA smoothed)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ewma_bits_out</span></code>:  Average outbound bit-rate (EWMA smoothed)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">peak_bits_in</span></code>:  Peak inbound bit-rate</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">peak_bits_out</span></code>:  Peak outbound bit-rate</p></li>
</ul>
</div></blockquote>
<p>Once initialised and clocked at the appropriate frequency, these
statistics can be obtained by querying the metrics library.</p>
<section id="initialization">
<h3><span class="section-number">61.6.1. </span>Initialization</h3>
<p>Before the library can be used, it has to be initialised by calling
<code class="docutils literal notranslate"><span class="pre">rte_stats_bitrate_create()</span></code>, which will return a bit-rate
calculation object. Since the bit-rate library uses the metrics library
to report the calculated statistics, the bit-rate library then needs to
register the calculated statistics with the metrics library. This is
done using the helper function <code class="docutils literal notranslate"><span class="pre">rte_stats_bitrate_reg()</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">struct</span><span class="w"> </span><span class="nc">rte_stats_bitrates</span><span class="w"> </span><span class="o">*</span><span class="n">bitrate_data</span><span class="p">;</span><span class="w"></span>

<span class="n">bitrate_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rte_stats_bitrate_create</span><span class="p">();</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bitrate_data</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">rte_exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Could not allocate bit-rate data.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
<span class="n">rte_stats_bitrate_reg</span><span class="p">(</span><span class="n">bitrate_data</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="controlling-the-sampling-rate">
<h3><span class="section-number">61.6.2. </span>Controlling the sampling rate</h3>
<p>Since the library works by periodic sampling but does not use an
internal thread, the application has to periodically call
<code class="docutils literal notranslate"><span class="pre">rte_stats_bitrate_calc()</span></code>. The frequency at which this function
is called should be the intended sampling rate required for the
calculated statistics. For instance if per-second statistics are
desired, this function should be called once a second.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">tics_datum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rte_rdtsc</span><span class="p">();</span><span class="w"></span>
<span class="n">tics_per_1sec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rte_get_timer_hz</span><span class="p">();</span><span class="w"></span>

<span class="k">while</span><span class="p">(</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* ... */</span><span class="w"></span>
<span class="w">    </span><span class="n">tics_current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rte_rdtsc</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tics_current</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tics_datum</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">tics_per_1sec</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* Periodic bitrate calculation */</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">idx_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">idx_port</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cnt_ports</span><span class="p">;</span><span class="w"> </span><span class="n">idx_port</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">                </span><span class="n">rte_stats_bitrate_calc</span><span class="p">(</span><span class="n">bitrate_data</span><span class="p">,</span><span class="w"> </span><span class="n">idx_port</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">tics_datum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tics_current</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="cm">/* ... */</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
<section id="latency-statistics-library">
<h2><span class="section-number">61.7. </span>Latency statistics library</h2>
<p>The latency statistics library calculates the latency of packet
processing by a DPDK application, reporting the minimum, average,
and maximum nano-seconds that packet processing takes, as well as
the jitter in processing delay. These statistics are then reported
via the metrics library using the following names:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">min_latency_ns</span></code>: Minimum processing latency (nano-seconds)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">avg_latency_ns</span></code>:  Average  processing latency (nano-seconds)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mac_latency_ns</span></code>:  Maximum  processing latency (nano-seconds)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">jitter_ns</span></code>: Variance in processing latency (nano-seconds)</p></li>
</ul>
</div></blockquote>
<p>Once initialised and clocked at the appropriate frequency, these
statistics can be obtained by querying the metrics library.</p>
<section id="id2">
<h3><span class="section-number">61.7.1. </span>Initialization</h3>
<p>Before the library can be used, it has to be initialised by calling
<code class="docutils literal notranslate"><span class="pre">rte_latencystats_init()</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">lcoreid_t</span><span class="w"> </span><span class="n">latencystats_lcore_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rte_latencystats_init</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="n">rte_exit</span><span class="p">(</span><span class="n">EXIT_FAILURE</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Could not allocate latency data.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="triggering-statistic-updates">
<h3><span class="section-number">61.7.2. </span>Triggering statistic updates</h3>
<p>The <code class="docutils literal notranslate"><span class="pre">rte_latencystats_update()</span></code> function needs to be called
periodically so that latency statistics can be updated.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">latencystats_lcore_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">rte_lcore_id</span><span class="p">())</span><span class="w"></span>
<span class="w">    </span><span class="n">rte_latencystats_update</span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="library-shutdown">
<h3><span class="section-number">61.7.3. </span>Library shutdown</h3>
<p>When finished, <code class="docutils literal notranslate"><span class="pre">rte_latencystats_uninit()</span></code> needs to be called to
de-initialise the latency library.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">rte_latencystats_uninit</span><span class="p">();</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="timestamp-and-latency-calculation">
<h3><span class="section-number">61.7.4. </span>Timestamp and latency calculation</h3>
<p>The Latency stats library marks the time in the timestamp field of the
mbuf for the ingress packets and sets the <code class="docutils literal notranslate"><span class="pre">RTE_MBUF_F_RX_TIMESTAMP</span></code> flag of
<code class="docutils literal notranslate"><span class="pre">ol_flags</span></code> for the mbuf to indicate the marked time as a valid one.
At the egress, the mbufs with the flag set are considered having valid
timestamp and are used for the latency calculation.</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/DPDK_logo_vertical_rev_small.png" alt="Logo"/>
            </a></p>
<h1 class="logo"><a href="../index.html">Data Plane Development Kit</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../linux_gsg/index.html">Getting Started Guide for Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../freebsd_gsg/index.html">Getting Started Guide for FreeBSD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../windows_gsg/index.html">Getting Started Guide for Windows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sample_app_ug/index.html">Sample Applications User Guides</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Programmerâ€™s Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../howto/index.html">HowTo Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">DPDK Tools User Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../testpmd_app_ug/index.html">Testpmd Application User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nics/index.html">Network Interface Controller Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bbdevs/index.html">Baseband Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cryptodevs/index.html">Crypto Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../compressdevs/index.html">Compression Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vdpadevs/index.html">vDPA Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../regexdevs/index.html">REGEX Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mldevs/index.html">Machine Learning Device Driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dmadevs/index.html">DMA Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../gpus/index.html">General-Purpose Graphics Processing Unit Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../eventdevs/index.html">Event Device Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rawdevs/index.html">Rawdev Drivers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mempool/index.html">Mempool Device Driver</a></li>
<li class="toctree-l1"><a class="reference internal" href="../platform/index.html">Platform Specific Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing/index.html">Contributorâ€™s Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rel_notes/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">FAQ</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Programmerâ€™s Guide</a><ul>
      <li>Previous: <a href="vhost_lib.html" title="previous chapter"><span class="section-number">60. </span>Vhost Library</a></li>
      <li>Next: <a href="telemetry_lib.html" title="next chapter"><span class="section-number">62. </span>Telemetry Library</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      
      
      
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.3.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/prog_guide/metrics_lib.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>